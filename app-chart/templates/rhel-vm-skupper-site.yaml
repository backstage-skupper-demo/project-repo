kind: ConfigMap
apiVersion: v1
metadata:
  name: rhel-vm-inventory
  namespace: backstage
data:
  inventory.yml: |
    all:
      children:
        local:
          hosts:
            192.168.23.4:
              platform: "podman"
              init:
                siteName: rhel-vm
                ingressHosts:
                  - 192.168.23.4
              
              links:
                - host: proj1
              
        
        linked:
          hosts:
            proj1:
              ansible_connection: local
        
---
apiVersion: batch/v1
kind: Job
metadata:
  name: rhel-vm-skupper-site-init
  namespace: backstage
spec:
  selector: {}
  template:
    metadata:
      name: rhel-vm-skupper-site-init
    spec:
      serviceAccountName: pipeline
      containers:
        - name: skupper-ansible
          image: quay.io/mathianasj/ansible-skupper-pipeline@sha256:9ae7e91a7e65b29038435c804e5dc5d9161b337aba5fbb3d1b2f95c8a1cbce62
          command:
            - ansible-playbook
            - /site-creation.yaml
            - -i
            - /workspace/source/inventory.yml
            - -e
            - vault_url=$(VAULT_URL)
            - --private-key=/workspace/.ssh/id_rsa
          volumeMounts:
            - name: inventory
              mountPath: /workspace/source
            - name: ssh
              mountPath: /workspace/.ssh/id_rsa
              subPath: id_rsa
          env:
            - name: ANSIBLE_HOST_KEY_CHECKING
              value: "False"
            - name: VAULT_URL
              valueFrom:
                secretKeyRef:
                  name: vault-secret
                  key: vault-url
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-secret
                  key: vault-token
      volumes:
      - name: inventory
        configMap:
          name: rhel-vm-inventory
          defaultMode: 420
      - name: ssh
        secret:
          secretName: ssh-key
          defaultMode: 256
      restartPolicy: Never
